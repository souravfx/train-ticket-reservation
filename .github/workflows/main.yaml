name: CI-CD | Train Ticket Reservation

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  APP_NAME: train-ticket-reservation
  JAVA_VERSION: '17'

jobs:
# =====================================================
# 1. BUILD, TEST, SCAN & PACKAGE
# =====================================================
  build:
    name: Build & Scan
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout source
        uses: actions/checkout@v4

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: üî® Build with Maven
        run: mvn clean verify

      - name: üîç SonarQube Analysis
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=${{ env.APP_NAME }} \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      - name: üì¶ Upload WAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: war-file
          path: target/*.war

# =====================================================
# 2. PUSH ARTIFACT TO NEXUS
# =====================================================
  nexus:
    name: Upload to Nexus
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: üîê Configure Maven settings.xml
        run: |
          mkdir -p ~/.m2
          cat <<EOF > ~/.m2/settings.xml
          <settings>
            <servers>
              <server>
                <id>nexus</id>
                <username>${{ secrets.NEXUS_USERNAME }}</username>
                <password>${{ secrets.NEXUS_PASSWORD }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: üöÄ Deploy to Nexus
        run: mvn deploy -DskipTests

# =====================================================
# 3. BUILD DOCKER IMAGE, SCAN & PUSH TO ECR
# =====================================================
  docker:
    name: Docker Build & Push
    needs: nexus
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: üîë Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: üê≥ Build Docker Image
        run: |
          IMAGE_TAG=${{ github.run_number }}
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          docker build -t ${{ secrets.ECR_REPOSITORY }}:$IMAGE_TAG .

      - name: üîç Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: image
          image-ref: ${{ secrets.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          severity: HIGH,CRITICAL
          ignore-unfixed: true

      - name: üì§ Push Image to ECR
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          docker tag ${{ secrets.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} \
            $ACCOUNT_ID.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

          docker push $ACCOUNT_ID.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

# =====================================================
# 4. DEPLOY TO EKS (PROD)
# =====================================================
  deploy-eks:
    name: Deploy to EKS
    needs: docker
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: üì¶ Install kubectl
        run: |
          curl -LO https://storage.googleapis.com/kubernetes-release/release/stable.txt
          curl -LO https://storage.googleapis.com/kubernetes-release/release/$(cat stable.txt)/bin/linux/amd64/kubectl
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: üîÑ Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ secrets.EKS_CLUSTER_NAME }} \
            --region ${{ secrets.AWS_REGION }}

      - name: üöÄ Deploy Application
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

          kubectl set image deployment/train-ticket-deployment \
            train-ticket-container=$ACCOUNT_ID.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} \
            -n ${{ secrets.K8S_NAMESPACE }}

          kubectl rollout status deployment/train-ticket-deployment \
            -n ${{ secrets.K8S_NAMESPACE }}

# =====================================================
# 5. DEPLOY TO TOMCAT (DEV)
# ==========
